#include "veins/modules/application/traci/TraCIDemo11p.h"
#include "veins/modules/application/traci/TraCIDemo11pMessage_m.h"
#include "veins/base/utils/FindModule.h"

#include <omnetpp/cmessage.h>
#include <string>
#include <list>

using namespace omnetpp;
using namespace veins;

Define_Module(veins::TraCIDemo11p);

/****************************************************************
 *  INIT
 ****************************************************************/
void TraCIDemo11p::initialize(int stage)
{
    DemoBaseApplLayer::initialize(stage);

    if (stage == 0) {
        EV << "ðŸš— TraCIDemo11p inicializado\n";
        hasCrashed = false;
        currentSubscribedServiceId = -1;

        /* Imprime las rutas disponibles para depuraciÃ³n */
        std::list<std::string> rids = traci->getRouteIds();
        EV << "ðŸ”€ Rutas en SUMO:\n";
        for (auto& r : rids) EV << "  - " << r << endl;
    }
}

/****************************************************************
 *  SELF MESSAGES â€“ comprueba colisiÃ³n propia y emite WSM
 ****************************************************************/
void TraCIDemo11p::handleSelfMsg(cMessage* msg)
{
    /* Paso base (maneja beacons y temporizadores internos) */
    DemoBaseApplLayer::handleSelfMsg(msg);

    /* Solo interesa si aÃºn no hemos marcado colisiÃ³n */
    if (!hasCrashed) {
        /* TraCI: nÃºmero de colisiones acumuladas de este vehÃ­culo */
        int collisions = traciVehicle->getCollisions().size();
        if (collisions > 0) {
            hasCrashed = true;
            crashPosition = mobility->getPositionAt(simTime());

            /* Cambia color para identificar el choque */
            traciVehicle->changeColor(veins::TraCIColor(255, 0, 0, 255));

            /* Construye y envÃ­a WSM de alerta */
            TraCIDemo11pMessage* wsm = new TraCIDemo11pMessage("CollisionAlert");
            wsm->setSenderAddress(myId);
            wsm->setWsmData("COLLISION");
            wsm->setCollision(true);
            wsm->setCollisionX(crashPosition.x);
            wsm->setCollisionY(crashPosition.y);
            wsm->setRecipientAddress(LAddress::BROADCAST.getAddress());

            EV << "âš ï¸  Enviando WSM de colisiÃ³n desde " << myId
               << " @ " << crashPosition << endl;

            sendDown(wsm);
        }
    }
}

/****************************************************************
 *  WSA â€“ no afecta a colisiones (ejemplo de suscripciÃ³n)
 ****************************************************************/
void TraCIDemo11p::onWSA(DemoServiceAdvertisment* wsa)
{
    if (currentSubscribedServiceId == -1) {
        mac->changeServiceChannel(static_cast<Channel>(wsa->getTargetChannel()));
        currentSubscribedServiceId = wsa->getPsid();
        EV << "ðŸ“» Subscrito al servicio " << currentSubscribedServiceId << endl;
    }
}

/****************************************************************
 *  WSM â€“ recepciÃ³n de alerta y cambio de ruta
 ****************************************************************/
void TraCIDemo11p::onWSM(BaseFrame1609_4* frame)
{
    TraCIDemo11pMessage* wsm = check_and_cast<TraCIDemo11pMessage*>(frame);

    /* Solo procesar mensajes de colisiÃ³n */
    if (!wsm->getCollision()) return;

    Coord crash(wsm->getCollisionX(), wsm->getCollisionY(), 0);
    Coord myPos = mobility->getPositionAt(simTime());
    double dist = crash.distance(myPos);

    /* Umbral: 300 m */
    if (dist < 300 && (!hasCrashed)) {
        EV << "ðŸš§ ColisiÃ³n a " << dist << " m; cambiando a altRoute\n";

        /* Cambia ruta (prioridad 9999 fuerza cambio inmediato) */
        try {
            traciVehicle->changeRoute("altRoute", 9999);
            traciVehicle->changeColor(veins::TraCIColor(0, 255, 0, 255)); // verde
        }
        catch (Veins::TraCIException& e) {
            EV << "âŒ Error al cambiar ruta: " << e.what() << endl;
        }
    }
}

/****************************************************************
 *  POSICIÃ“N â€“ sÃ³lo registra la hora de Ãºltimo movimiento
 ****************************************************************/
void TraCIDemo11p::handlePositionUpdate(cObject* obj)
{
    DemoBaseApplLayer::handlePositionUpdate(obj);
    lastDroveAt = simTime();
}

#include "veins/modules/application/traci/TraCIDemo11p.h"
#include "veins/modules/application/traci/TraCIDemo11pMessage_m.h"
#include "veins/base/utils/FindModule.h"

#include <omnetpp/cSimulation.h>
#include <iomanip>
#include <list>

using namespace veins;

Define_Module(veins::TraCIDemo11p);

/****************************************************************
 *  INICIALIZACIÃ“N
 ****************************************************************/
void TraCIDemo11p::initialize(int stage)
{
    DemoBaseApplLayer::initialize(stage);

    if (stage == 0) {
        hasCrashed = false;
        currentSubscribedServiceId = -1;

        /* Mostrar las rutas declaradas en SUMO */
        std::list<std::string> rids = traci->getRouteIds();
        EV << "ðŸ“ Rutas disponibles:" << endl;
        for (auto& r : rids) EV << "  - " << r << endl;
    }
}

/****************************************************************
 *  MENSAJES INTERNOS: detector de colisiones
 ****************************************************************/
void TraCIDemo11p::handleSelfMsg(cMessage* msg)
{
    /* DemoBaseApplLayer maneja sus relojes internos          */
    DemoBaseApplLayer::handleSelfMsg(msg);

    /* Comprobar colisiÃ³n propia solo si aÃºn no la registrÃ©   */
    if (!hasCrashed && traciVehicle->getCollidingVehiclesNumber() > 0) {
        hasCrashed = true;
        crashPosition = mobility->getCurrentPosition();

        EV << "âš ï¸  ColisiÃ³n detectada en "
           << crashPosition.x << "," << crashPosition.y << endl;

        /* Cambiar color a rojo */
        traciVehicle->changeColor(veins::TraCIColor(255, 0, 0, 255));

        /* Construir y transmitir WSM de alerta */
        auto danger = new TraCIDemo11pMessage();
        danger->setDemoData("COLLISION");
        danger->setSenderAddress(myId);
        danger->setPosition(crashPosition);
        populateWSM(danger);
        sendDown(danger);
    }
}

/****************************************************************
 *  WSA: suscripciÃ³n al canal de servicio (sin cambios)
 ****************************************************************/
void TraCIDemo11p::onWSA(DemoServiceAdvertisment* wsa)
{
    if (currentSubscribedServiceId == -1) {
        mac->changeServiceChannel(static_cast<Channel>(wsa->getTargetChannel()));
        currentSubscribedServiceId = wsa->getPsid();
        EV << "ðŸ›°ï¸  Subscrito a servicio " << currentSubscribedServiceId << endl;
    }
}

/****************************************************************
 *  WSM: procesar alertas de colisiÃ³n y desviarse
 ****************************************************************/
void TraCIDemo11p::onWSM(BaseFrame1609_4* frame)
{
    auto* msg = dynamic_cast<TraCIDemo11pMessage*>(frame);
    if (!msg) return;                              // no es nuestro tipo

    /* Solo reaccionar a mensaje de colisiÃ³n */
    if (strcmp(msg->getDemoData(), "COLLISION") != 0) return;

    /* Calcular distancia */
    Coord here = mobility->getCurrentPosition();
    double dist = here.distance(msg->getPosition());

    if (dist < 300 && !hasCrashed) {               // yo no choquÃ© pero estoy cerca
        EV << "ðŸš§ RecibÃ­ alerta, colisiÃ³n a " << dist << " m â†’ cambiando a altRoute"
           << endl;

        try {
            traciVehicle->changeRoute("altRoute", 9999);   // prioridad alta
            traciVehicle->changeColor(veins::TraCIColor(0, 255, 0, 255)); // verde
        }
        catch (Veins::TraCIException& e) {
            EV << "âŒ Error al cambiar ruta: " << e.what() << endl;
        }
    }
}

/****************************************************************
 *  POSICIÃ“N: actualizaciÃ³n estÃ¡ndar
 ****************************************************************/
void TraCIDemo11p::handlePositionUpdate(cObject* obj)
{
    DemoBaseApplLayer::handlePositionUpdate(obj);
}
